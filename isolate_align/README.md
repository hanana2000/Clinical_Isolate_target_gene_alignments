# Align isolate top hits with reference target genes 

This script will align two sets of target genes to the top hits generated by compare_hits_between_refs.py. It will output an alignment for each isolate per target gene, and a summary file per category of target. 

### 🧰 Requirements

- Python 3.8+
- MAFFT (in $PATH)
- Python packages:
- biopython
- pandas

Install Python deps:

```bash
pip install biopython pandas

```

## quick start with test data: 

```bash 
python3 align_to_isolates_recurs.py --target_genes1 fake_target_genesPAO1 --target_genes2 fake_target_genesPA14 --path_tophits fake_tophits_crosscheck_GCA --isolate_proteins fake_isolate_proteins_GCA --output_folder fake_results_GCA

or 

python3 align_to_isolates_recurs.py --target_genes1 fake_target_genesPAO1 --target_genes2 fake_target_genesPA14 --path_tophits fake_tophits_crosscheck_GCF --isolate_proteins fake_isolate_proteins_GCF --output_folder fake_results_GCF

```

## Usage 

If you run align_to_isolates_recurs.py without required arguments you will get this message: 

```bash 
usage: align_to_isolates_recurs.py [-h] --target_genes1 TARGET_GENES1 --target_genes2 TARGET_GENES2
                                   --path_tophits PATH_TOPHITS --isolate_proteins ISOLATE_PROTEINS
                                   --output_folder OUTPUT_FOLDER

Align isolate top hits from top_hits_isolates/compare_hits_between_refs.py to reference target genes in TWO
SETS of target proteins.

options:
  -h, --help            show this help message and exit
  --target_genes1 TARGET_GENES1
                        Path to the folder with subdirectories containing .faa files with first set of
                        reference target genes.
  --target_genes2 TARGET_GENES2
                        Path to the folder with subdirectories containing .faa files with second set of
                        reference target genes.
  --path_tophits PATH_TOPHITS
                        Path to top hits folder generated by compare_hits_between_refs.py, with canonical and
                        unsure files.
  --isolate_proteins ISOLATE_PROTEINS
                        Path to the folder with all isolate proteins GCA.
  --output_folder OUTPUT_FOLDER
                        Path to the output folder where results will be saved.

```

To use this script, you must first have already run the top_hits_isolates/compare_hits_between_refs.py script of your isolate data and TWO SETS of target reference genes. Example: 

```bash 
└── 📁fake_tophits_crosscheck_GCA
    ├── fake_attack_genes_isolate_12345.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_attack_genes_isolate_12345.fsa_aa.gz.unsure_crosscheck.tsv
    ├── fake_attack_genes_isolate_56789.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_attack_genes_isolate_56789.fsa_aa.gz.unsure_crosscheck.tsv
    ├── fake_colorful_genes_isolate_12345.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_colorful_genes_isolate_12345.fsa_aa.gz.unsure_crosscheck.tsv
    ├── fake_colorful_genes_isolate_56789.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_colorful_genes_isolate_56789.fsa_aa.gz.unsure_crosscheck.tsv
    ├── fake_defense_genes_isolate_12345.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_defense_genes_isolate_12345.fsa_aa.gz.unsure_crosscheck.tsv
    ├── fake_defense_genes_isolate_56789.fsa_aa.gz.canonical_crosscheck.tsv
    ├── fake_defense_genes_isolate_56789.fsa_aa.gz.unsure_crosscheck.tsv
    └── summary.txt
```
The script uses:

- column 0 or 1 (depending on whether it’s PAO1 or PA14 side) for the target qseqid
- column "sseqid" for the isolate protein ID to align against

The script expects the target genes to be formated in subdirectories representing categories of genes. These MUST BE IN THE SAME ORDER as they were passed to compare_hits_between_refs.py. For example: 

```bash
└──📁target_genes1/
    └── 📁efflux/
        └── efflux_targets.faa
    └── 📁pili/
        └── pili_targets.faa
    └── 📁porin/
        └── porin_targets.faa

└──📁target_genes2/
    └── 📁efflux/
        └── efflux_targets.faa
    └── 📁pili/
        └── pili_targets.faa
    └── 📁porin/
        └── porin_targets.faa

```

you would pass align_to_isolates_recurs.py the PAO1_target_genes folder path. It expects TWO SETS of target genes which must be formatted the same. These MUST BE IN THE SAME ORDER as they were passed to compare_hits_between_refs.py. 

The align_to_isolates_recurs.py file can take isolate protein data formatted as the NCBI datasets command-line retrieval tool formats it, or as a flat directory. The datasets tool retreives the GCF data (RefSeq curated) with the directory structure as outlined below: 

```bash 
└── 📁isolates
    └── 📁ncbi_dataset
        └── 📁data
            └── 📁GCF_003968045.1
            │   ├── genomic.gff
            │   ├── protein.faa
            └── 📁GCF_003968115.1
            │   ├── genomic.gff
            │   ├── protein.faa
            ├── assembly_data_report.jsonl
            ├── dataset_catalog.json
    ├── md5sum.txt
    └── README.md

```

You want to pass the align_to_isolates_recurs.py script the /ncbi_dataset/data folder. 

The align_to_isolates_recurs.py script can also take GCA (or GCF) .fsa_aa.gz, .fasta, or .faa files that might have been manually downloaded. it expects flat data in this stucture: 

```bash
└── 📁isolate_proteins_GCA 
    ├── RXTE01P.1.fsa_aa.gz
    ├── RXTF01P.1.fsa_aa.gz
    ├── RXTH01P.1.fsa_aa.gz
    └── RXTQ01P.1.fsa_aa.gz
or 

└── 📁isolate_proteins_GCA 
    ├── RXTE01P.1.faa
    ├── RXTF01P.1.faa
    ├── RXTH01P.1.faa
    └── RXTQ01P.1.faa
or 

└── 📁isolate_proteins_GCA 
    ├── RXTE01P.1.fasta
    ├── RXTF01P.1.fasta
    ├── RXTH01P.1.fasta
    └── RXTQ01P.1.fasta
    
```

You want to pass the align_to_isolates_recurs.py script the /isolate_proteins_GCA folder. 


## Output 

```bash 
/output_folder/
└── efflux_alignments/
    ├── efflux_PAO1_all.tsv               # per-isolate, per-gene stats (PAO1 reference)
    ├── efflux_PA14_all.tsv               # per-isolate, per-gene stats (PA14 reference)
    ├── efflux_summary_all.txt            # which isolates are missing genes or mismatched counts
    ├── RXTE01P_PAO1/
    │   ├── per_gene_alns/
    │   │   ├── RXTE01P_PAO1_gene_0.aln   # single gene MAFFT CLUSTAL alignment
    │   │   ├── RXTE01P_PAO1_gene_0.fasta # single gene MAFFT FASTA alignment
    │   │   └── ...
    │   ├── efflux_combined.txt           # concatenated CLUSTAL blocks for quick viewing
    │   └── summary_RXTE01P_efflux.txt    # gap/substitution/match counts, identity, etc.
    └── RXTE01P_PA14/
        └── (same structure as above)

```

TSV columns (per gene per isolate)

- isolate_id
- id1, id2 (aligned sequence IDs)
- gaps_seq1, gaps_seq2
- conservative_subs, weak_subs, complete_mismatches
- TOTAL_individual_aa_diffs
- indel_count
- identical_matches
- %_identity
- alignment_length
- coverage_seq1, coverage_seq2
- ref_desc, iso_desc

Identity and substitution classes follow CLUSTAL strong/weak group conventions in the script.


# 🙋‍♀️ Author/ 📬 Contact

For questions or suggestions, contact: 

Hannah Kapoor
📧 hannahkapoor00@gmail.com 